{% extends "consul_base.html" %}
{% block styles %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/consultation.css') }}">
{% endblock %}
{% block content %}
{% if current_user.is_authenticated %}
{% if current_user.is_prof %}
<h1>Consulter le matériel</h1>
<form id="search" action="recherche" role="search" method="post">
    <input type="search" name="search" id="searchinput" placeholder="Rechercher un matériel ..." oninput="change()">
    <select name="Domaine" id="Domaine" onchange="change()">
        <option value="">Domaine</option>
        {% for domaine in domaines %}
        <option value="{{ domaine.code }}">{{ domaine.nom }}</option>
        {% endfor %}
    </select>
    <select name="Catégorie" id="Categorie" onchange="change()">
        <option value="">Categorie</option>
        {% for categorie in categories %}
        <option value="{{ categorie.code }}">{{ categorie.nom }}</option>
        {% endfor %}
    </select>
    <button type="reset" id="searchButton">reset</button>
    <!-- recherche pas fonctionnel -->
</form>
<div class="info">
    <div>
        <div class="liste_mat">
            <ul id="materielsList">
                {% for materiel in materiels %}
                <li>
                    <div class="item_mat">
                        <img src="data:image/png;base64,{{ materiel.get_image() }}" alt="{{ materiel.nom }}">
                        <h2 id="{{ materiel.reference }}" onclick="edit(this.id)">{{ materiel.nom }}</h2>
                    </div>
                </li>
                {% endfor %}
            </ul>
        </div>
        <div>
            {% if current_user.modifications == True %}
            <button id="buttonAdd" type="button">Ajouter du Materiel</button>
            {% endif %}
        </div>
    </div>
    <div>
        <div class="description">
            <form action="" method="post">
                <h2 id="nom">{{ form.nom.data}}</h2>
                <div class="chiffre">
                    <label>Domaine : </label><input type="text"  id="domaine" value="{{ form.domaine.data }}" disabled>
                    <label >Reférence : </label><input type="text" id="categorie" value="{{ form.categorie.data }}" disabled>
                    <label>Reference : </label><input type="text" id="reference" value="{{ form.reference.data }}" disabled>
                    {% if form.domaine.data == "Produits Chimiques" %}
                    <label >Quantité Restante : </label><input type="text" id="quantiteR" value="{{form.quantiteRes.data }}" disabled>
                    {% endif %}
                    <label>Quantité Totale :</label><input type="text" id="quantiteT" value="{{ form.quantiteTot.data }}" disabled>
                </div>
                <div class="textu">
                    <img id="image" src="data:image/png;base64,{{ current_mat.get_image() }}" alt="{{ current_mat.nom }}">
                    <input type="text" id="complements" value="{{ form.description.data }}" disabled>
                </div>
            </form>
        </div>
        <div class="button">
            {% if current_user.modifications == True %}
            <button id="buttonModifier">Modifier</button>
            <button id="buttonSupp">Supprimer</button>
            {% endif %}
            <button id="buttonImprimer">Imprimer</button>
            <button id="buttonFDS">Voir FDS</button>
        </div>
    </div>
</div>
<script>

    function change() {
        const searchQuery = document.getElementById('searchinput').value;
        const selectedDomaine = document.getElementById('Domaine').value;
        const selectedCategorie = document.getElementById('Categorie').value;
        
        const optionC = document.createElement('option');
        optionC.value = "";
        optionC.textContent = "Catégorie";

        fetch(`/get_categories?domaine=${selectedDomaine}`)
            .then(response => response.json())
            .then(data => {
                dataCategories = data.categories;
                const CatList = document.getElementById('Categorie');
                CatList.innerHTML = "";

                CatList.appendChild(optionC);
                dataCategories.forEach(categorie => {
                    const option = document.createElement('option');
                    option.value = categorie.codeC;
                    option.textContent = categorie.nom;
                    if (option.value == selectedCategorie) {
                        option.selected = true;
                    }
                    CatList.appendChild(option);
                });                
                ListeMateriauxMAJ();
            })
            .catch(error => console.error('Erreur : ' + error));
    }

    function ListeMateriauxMAJ() {
        const searchQuery = document.getElementById('searchinput').value;
        const selectedDomaine = document.getElementById('Domaine').value;
        const selectedCategorie = document.getElementById('Categorie').value;
        // Envoyer une requête Ajax pour mettre à jour la liste de matériaux
        fetch(`/consult/recherche?search=${searchQuery}&domaine=${selectedDomaine}&categorie=${selectedCategorie}`)
            .then(response => response.json())
            .then(data => {
                dataMateriels = data.materiels;
                const materielsList = document.getElementById('materielsList');
                materielsList.innerHTML = "";
                dataMateriels.forEach(material => {
                    const materialItem = document.createElement('li');

                    const div = document.createElement('div');
                    div.classList.add('item_mat');

                    const img = document.createElement('img');
                    img.src = "data:image/png;base64," + material.image;
                    img.alt = material.nom;
                    const h2 = document.createElement('h2');
                    h2.id = material.reference;
                    h2.onclick = function () { edit(this.id) };
                    h2.textContent = material.nom;

                    div.appendChild(img);
                    div.appendChild(h2);
                    materialItem.appendChild(div);
                    materielsList.appendChild(materialItem);
                });
            })
            .catch(error => console.error('Erreur : ' + error));
    }

    function edit(id) {
        var labelNom = document.getElementById("nom");
        var labelDomaine = document.getElementById("domaine");
        var labelCategorie = document.getElementById("categorie");
        var labelReference = document.getElementById("reference");
        var labelQuanR = document.getElementById("quantiteR");
        var labelQuanT = document.getElementById("quantiteT");
        var labelComplements = document.getElementById("complements");
        var labelImage = document.getElementById("image");


        fetch('/get_info_Materiel/' + id)
            .then(response => response.json())
            .then(data => {
                labelNom.value = data.nom;
                labelDomaine.value = data.domaine;
                labelCategorie.value = data.categorie;
                labelQuanT.value = data.quantite_global;
                labelReference.value = data.reference;
                if (labelQuanR) {
                    labelQuanR.value = data.quantite_restante;
                }
                labelComplements.value = data.complements;
                labelImage.src = "data:image/png;base64," + data.image;
                labelImage.alt = data.nom;

            })
            .catch(error => console.error('Erreur : ' + error));

    }
</script>
{% endif %}
{% endif %}
{% endblock %}