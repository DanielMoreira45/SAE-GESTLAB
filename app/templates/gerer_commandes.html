{% extends "consul_base.html" %}
{% block styles %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/gerer_commandes.css') }}">
{% endblock %}

{% block content %}
{% if current_user.is_authenticated %}
{% if current_user.is_etablissement() or current_user.is_prof() %}
    {% if current_user.is_etablissement() %}
        <h1>Gérer les commandes</h1>
    {% else %}
        <h1>Voir les commandes</h1>
    {% endif %}
    <section class="search_buttons">
        <input type="search" name="recherche" id="recherche" placeholder="Rechercher" oninput="update_categorie()">
        <select name="domaine" id="domaine-select" onchange="update_categorie()">
            <option id="domaine" value="">-- Domaine --</option>
            {% for domaine in liste_domaines %}
                <option id="domaineOption" value="{{ domaine.codeD }}">{{ domaine.nomD }}</option>
            {% endfor %}
        </select>
        <select name="categorie" id="categorie-select" onchange="update_categorie()">
            <option id="categorie" value="">-- Categorie --</option>
        </select>
        <select name="statut" id="statut-select" onchange="update_categorie()">
            <option id="statut" value="">-- Statut --</option>
            {% for statut in liste_statuts %}
                <option id="statut" value="{{ statut.idStatut }}">{{ statut.nomStatut }}</option>
            {% endfor %}
        </select>
        <button name="btn-reset" value="reset" class="yellow-button" onclick="reset()">Reset</button>
    </section>
    <section class="commands">
        <ul id="liste">
            {% for command in liste_commandes %}
                <li>
                    <button id="{{ command.numeroCommande }}" class="command_button" onclick="edit(this.id)">
                        <img src="{{ url_for('static', filename='images/black_square.png') }}" alt="image commande" class="img">
                        <p>{{ command.materiel.nomMateriel }}</p>
                    </button>
                </li>
            {% endfor %}
        </ul>
    </section>
    <section class="right">
        <div class="materiel">
            <h2><label id="nom"></label></h2>
            <img src="{{ url_for('static', filename='images/black_square.png') }}" alt="image commande">
            <div class="les_labels">
                <label for="numero" id="label-numero"></label>
                <label for="statut" id="label-statut"></label>
                <label for="domaine" id="label-domaine"></label>
                <label for="categorie" id="label-categorie"></label>
                <label for="quantite" id="quantite"></label>
                <label for="user" id="user"></label>
            </div>
        </div>
        <div class="action_buttons">
            <input type="button" class="yellow-button" value="Imprimer" onclick='imprimer()'>
            {% if current_user.is_etablissement() %}
                <input type="button" class="annuler" id="annuler" value="Annuler la commande" onclick="validate('False')">
                <input type="button" class="valider" id="valider" value="Valider la commande" onclick="validate('True')">
            {% endif %}
        </div>
    </section>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            var firstCommandButton = document.querySelector(".command_button");
            if (firstCommandButton) {
                var commandRef = firstCommandButton.getAttribute("id");
                edit(commandRef);
            }
            update_categorie();
            
        });

        function edit(id) {
            var labelNom = document.getElementById("nom");
            var labelNumero = document.getElementById("label-numero")
            var labelDomaine = document.getElementById("label-domaine");
            var labelCategorie = document.getElementById("label-categorie");
            var labelStatut = document.getElementById("label-statut");
            var labelQuantite = document.getElementById("quantite");
            var labelUser = document.getElementById("user");
            if (id == 0){
                labelNom.textContent = "";
                labelNumero.textContent = "";
                labelDomaine.textContent = "";
                labelCategorie.textContent = "";
                labelStatut.textContent = "";
                labelQuantite.textContent = "";
                labelUser.textContent = "";
            }
            else {
                fetch(`/commandes/get_command_info/?id=${id}`)
                    .then(response => response.json())
                    .then(data => {
                        labelNom.textContent = data.nom;
                        labelNumero.textContent = "Numéro de commande : "+id
                        labelDomaine.textContent = "Domaine : "+data.domaine;
                        labelCategorie.textContent = "Catégorie : "+data.categorie;  
                        labelStatut.textContent = "Statut : "+data.statut;   
                        if (data.unite == null){
                            labelQuantite.textContent = "Quantité commandée : "+data.quantite
                        } else {labelQuantite.textContent = "Quantité commandée : "+data.quantite+" "+data.unite;}
                        labelUser.textContent = "Commande effectuée par "+data.user;
                        
                        if (data.statut == "A valider"){
                            document.getElementById("valider").value = "Valider la commande";
                            document.getElementById("annuler").disabled = false;
                            document.getElementById("valider").disabled = false;
                        }
                        else if (data.statut == "En cours"){
                            document.getElementById("valider").value = "Commande livrée";
                            document.getElementById("valider").disabled = false;
                            document.getElementById("annuler").disabled = true;
                        }
                        else{
                            document.getElementById("annuler").disabled = true;
                            document.getElementById("valider").disabled = true;
                        }
                    })
                    .catch(error => console.error('Erreur : ' + error));  
            }
        }

        function search(){
            recherche = document.getElementById("recherche").value;
            domaine = document.getElementById("domaine-select").value;
            categorie_selected = document.getElementById("categorie-select").value;
            statut = document.getElementById("statut-select").value;
            fetch(`/commandes/search/?recherche=${recherche}&domaine=${domaine}&categorie=${categorie_selected}&statut=${statut}`)
                .then(response => response.json())
                .then(data => {  
                    var liste_commandes_search = data.liste_commandes;
                    var ul = document.getElementById("liste");
                    ul.innerHTML = "";
                    if (liste_commandes_search.length > 0){
                        
                        liste_commandes_search.forEach(function(commande) {
                            var li = document.createElement("li");
                            var button = document.createElement("button");
                            button.id = commande.numero;
                            button.className = "command_button";
                            button.addEventListener("click", function(){
                                edit(commande.numero)
                            });
                            var p = document.createElement("p");
                            p.textContent = commande.nom;
                            var image = document.createElement("img");
                            image.src = "{{ url_for('static', filename='images/black_square.png') }}";
                            image.alt = "image commande";
                            image.className = "img";
                            button.appendChild(image);
                            button.appendChild(p);
                            li.appendChild(button);
                            ul.appendChild(li);
                            edit(liste_commandes_search[0].numero);
                        });
                        
                    }
                    else{
                        var li = document.createElement("li");
                        var p = document.createElement("p");
                        p.textContent = "Aucunes commandes trouvées pour cette recherche.";
                        li.appendChild(p);
                        ul.appendChild(li);
                        edit(0);
                    }
                    
                })
        }

        function update_categorie(){
            recherche = document.getElementById("recherche").value
            domaine = document.getElementById("domaine-select").value
            categorie_selected = document.getElementById("categorie-select").value
            statut = document.getElementById("statut-select").value
            fetch(`/commandes/search/?recherche=${recherche}&domaine=${domaine}&categorie=${categorie_selected}&statut=${statut}`)
                .then(response => response.json())
                .then(data => {  
                    document.getElementById("categorie-select").innerHTML = '<option id="categorie" value="">-- Categorie --</option>';
                    data.liste_categories.forEach(function(categorie){
                        var option = document.createElement("option");
                        option.value = categorie.codeC;
                        option.textContent = categorie.nomC;
                        if (option.value == categorie_selected){
                            option.selected = true;
                        }
                        document.getElementById("categorie-select").appendChild(option);
                    });
                    search()


                })
                .catch(error => console.error('Erreur : ' + error));     
        }

        function imprimer(){
            recherche = document.getElementById("recherche").value
            domaine = document.getElementById("domaine-select").value
            categorie_selected = document.getElementById("categorie-select").value
            statut = document.getElementById("statut-select").value
            fetch(`/commandes/creer_pdf?search=${recherche}&domaine=${domaine}&categorie=${categorie_selected}&statut=${statut}`)
                .then(response => response.json())
                .then(data => {
                    //Afficher popup pour imprimer
                })
                .catch(error => console.error('Erreyr : ' + error));
        }

        function validate(validee){
            var id = document.getElementById("label-numero").textContent;
            fetch(`/commandes/validate/?validee=${validee}&id=${id}`)
            .then(response => response.json())
            .then(data => {
                update_categorie();
                edit(id);
            })
            .catch(error => console.errot('Erreur : ' + error))
        }

        function reset(){
            document.getElementById("recherche").value = "";
            document.getElementById("domaine").selected = true;
            document.getElementById("categorie").selected = true;
            document.getElementById("statut").selected = true;
            update_categorie();
        }

    </script>
{% endif %}
{% endif %}
{% endblock %}
jjjjj